# Render.com Deployment Guide (SQLite)

This guide covers deploying the Django backend to Render.com using SQLite (simple, persistent on disk).

## Prerequisites

1. **GitHub repository** with your code pushed (already done ✓)
2. **Render.com account** (https://render.com, free tier available)
3. **Sentry project** (error monitoring, https://sentry.io)

## Quick Start (5 minutes)

### 1. Connect GitHub to Render

1. Go to https://dashboard.render.com
2. Click **New +** → **Web Service**
3. Select **Build and deploy from Git repository**
4. Click **Connect GitHub** and authorize Render
5. Select this repo: `luminatv`
6. Choose branch: `main`
7. Click **Next**

### 2. Configure Deployment Settings

Fill in the form:

| Field | Value |
|-------|-------|
| **Name** | `luminatv-backend` |
| **Root Directory** | `luminatv` |
| **Runtime** | `Python 3` |
| **Build Command** | `pip install -r requirements.txt && python manage.py collectstatic --no-input && python manage.py migrate && python manage.py check --deploy` |
| **Start Command** | `gunicorn --workers 2 --bind 0.0.0.0:$PORT luminatv.wsgi:application` |
| **Plan** | `Standard` (or `Free` for testing; note: free tier sleeps after 15 min inactivity) |

### 3. Add Environment Variables

Click **Advanced** → **Environment Variables**. Add:

```
DJANGO_ALLOWED_HOSTS=luminatv-backend.onrender.com
DJANGO_CSRF_TRUSTED_ORIGINS=https://luminatv-backend.onrender.com
SENTRY_DSN=https://your-dsn@o4510922978557952.ingest.de.sentry.io/4510922984783952
```

Other vars are auto-generated by Render or set in `render.yaml`.

### 4. Add Persistent Disk for SQLite

Click **Advanced** → **Disks**:
- Name: `db`
- Mount Path: `/opt/render/db`
- Size: `5 GB`

This ensures your SQLite database persists across redeploys.

### 5. Deploy

Click **Create Web Service**.

Render will:
1. Clone your repo
2. Run build command (`pip install`, `collectstatic`, `migrate`)
3. Start gunicorn server
4. Provide a URL: `https://luminatv-backend.onrender.com`

**Initial deployment:** 2-5 minutes

---

## Environment Variables (Complete List)

### Auto-Generated by Render:
- `DJANGO_SECRET_KEY` — randomly generated, unique per deploy

### Set in render.yaml (use defaults):
- `DJANGO_DEBUG=False`
- `DJANGO_SECURE_SSL_REDIRECT=True`
- `DJANGO_HSTS_SECONDS=31536000`
- `DJANGO_CSP_REPORT_ONLY=False`
- `SENTRY_TRACES_SAMPLE_RATE=0.1`

### MUST SET MANUALLY in Render Dashboard:

```
# Copy your actual Sentry DSN from https://sentry.io → Project Settings → Client Keys
SENTRY_DSN=https://xxx@oxxxxx.ingest.de.sentry.io/xxxxxx

# Your Render domain (displayed after deploy)
DJANGO_ALLOWED_HOSTS=luminatv-backend.onrender.com
DJANGO_CSRF_TRUSTED_ORIGINS=https://luminatv-backend.onrender.com
```

---

## Database Setup (SQLite)

### How it works:
- SQLite database stored at `/opt/render/db/db.sqlite3`
- Persisted via Render disk (survives redeploys)
- Migrations auto-run during builds
- No external database service needed

### Limitations:
- Single instance only (no horizontal scaling)
- Suitable for low-to-medium traffic
- Good for MVP, prototypes, or internal tools

### If you outgrow SQLite:
See "Upgrading to PostgreSQL" section below.

---

## Monitoring & Health Checks

### Health Check Endpoint:
```bash
curl https://luminatv-backend.onrender.com/health/
# Returns: {"status": "healthy", "version": "1.0"}
```

Configure in Render Dashboard:
1. **Settings** → **Health Check**
2. Path: `/health/`
3. Check interval: `60 seconds`

### View Logs:
- **Render Dashboard** → Select service → **Logs** tab
- Shows Django output, gunicorn startup, errors

### Error Tracking:
- **Sentry Dashboard** → Real-time errors, CSP violations, performance
- Set `SENTRY_DSN` to capture all errors

### Status Endpoint:
```bash
curl https://luminatv-backend.onrender.com/status/
# Returns: {"service": "luminatv-backend", "status": "ok", "django_version": "6.0", ...}
```

---

## Continuous Deployment (Auto-Deploy)

By default, every push to `main` triggers a new deploy:

1. You push to GitHub
2. Render detects change
3. Runs build command
4. Redeploys service (zero downtime with rolling restart)

To disable: Render Dashboard → **Settings** → **Auto-Deploy** → toggle off.

---

## Backups & Data Persistence

### SQLite Database Backup:

**Automated (via Render disk):**
- Data persists on Render disk across redeploys
- No manual backup needed for simple deployments

**Manual backup to local:**
```bash
# Download DB from Render (via SSH not available on free tier)
# Alternative: use Render CLI or scheduled jobs

# Or use your local backup script to periodically export:
python backup_database.py
# Then commit backups to GitHub or upload to cloud storage
```

### Persistent Data:
- Render disk mounted at `/opt/render/db/`
- Re-attach same disk on redeploy → data persists

---

## Cost Breakdown

| Component | Free Tier | Starter Plan |
|-----------|-----------|--------------|
| **Web Service** | $0 (512MB RAM, 0.5 CPU, sleeps) | $7/mo |
| **Disk (5GB)** | $0.20/GB = $1/mo | Included |
| **Bandwidth** | 100GB/mo | Included |
| **Uptime** | ~99.9% but sleeps after 15min inactivity | 99.99% |

**Recommendation**: Free tier for testing, Starter ($7+) for production.

---

## Troubleshooting

### Deploy fails with "Build command failed":
```bash
# Check logs in Render dashboard
# Common causes:
1. requirements.txt syntax error
2. Python version not available
3. Migration conflicts

# Fix: Test locally first
cd limunatv
python manage.py migrate
python manage.py check --deploy
```

### Server returns 500 error:
1. Check Sentry dashboard for exception details
2. Check Render logs tab
3. Likely causes:
   - Env var missing (DJANGO_SECRET_KEY, SENTRY_DSN)
   - Database migration failed
   - Static files not collected

**Check health endpoint:**
```bash
curl https://luminatv-backend.onrender.com/health/
```

### Service keeps restarting:
1. Check **Render Dashboard** → **Events** tab for crash info
2. Likely causes:
   - Out of memory (free tier: 512MB)
   - Infinite loop in startup code
   - Environment variable mismatch

**Solution**: Upgrade plan or check code for memory leaks.

### CSP violations in browser:
1. Check Sentry dashboard for violation details
2. Update `CONTENT_SECURITY_POLICY` in `limunatv/limunatv/settings.py`
3. Redeploy

---

## Security Checklist (Pre-Production)

- [ ] `DJANGO_DEBUG=False` in production
- [ ] `SENTRY_DSN` properly set and events flowing
- [ ] `DJANGO_ALLOWED_HOSTS` matches your domain
- [ ] `DJANGO_SECURE_SSL_REDIRECT=True` (forces HTTPS)
- [ ] HSTS enabled (`DJANGO_HSTS_SECONDS > 0`)
- [ ] CSP enforced (`CSP_REPORT_ONLY=False`)
- [ ] Health check endpoint `/health/` responding
- [ ] `python manage.py check --deploy` passes
- [ ] Custom domain configured (optional)

---

## Custom Domain (Optional)

1. Buy a domain (e.g., `api.example.com` from GoDaddy, Namecheap, etc.)
2. In Render Dashboard → **Settings** → **Custom Domains**
3. Add: `api.example.com`
4. Render generates DNS records
5. Update your domain registrar's DNS to point to Render nameservers
6. Wait 24-48h for DNS propagation
7. SSL certificate auto-provisioned by Render (Let's Encrypt)

---

## Upgrading to PostgreSQL (Future)

If you outgrow SQLite, migrate to PostgreSQL:

1. In Render Dashboard, create PostgreSQL service ($7+/mo)
2. Install `dj-database-url` in requirements.txt
3. Update settings.py to use DATABASE_URL env var:
   ```python
   import dj_database_url
   DATABASES = {'default': dj_database_url.config(default='sqlite:///db.sqlite3')}
   ```
4. Set `DATABASE_URL` env var in Render Dashboard
5. Run migrations on PostgreSQL
6. Point web service to PostgreSQL

---

## References

- [Render Docs](https://render.com/docs)
- [Django Deployment Checklist](https://docs.djangoproject.com/en/6.0/howto/deployment/checklist/)
- [Gunicorn Configuration](https://docs.gunicorn.org/en/stable/configure.html)
- [Sentry Django Integration](https://docs.sentry.io/platforms/python/integrations/django/)
